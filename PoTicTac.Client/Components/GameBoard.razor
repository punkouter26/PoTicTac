@using PoTicTac.Client.Models

<div class="game-board-container">
    <div class="game-board retro-glow">
        @for (int row = 0; row < GameState.Board.GetLength(0); row++)
        {
            @for (int col = 0; col < GameState.Board.GetLength(1); col++)
            {
                var currentRow = row;
                var currentCol = col;
                var value = GameState.Board[row, col];
                var isLastMove = LastMove?.Row == row && LastMove?.Col == col;
                var isWinningCell = GameState.WinningCells?.Any(cell => cell[0] == row && cell[1] == col) == true;
                
                <div class="cell @GetCellClasses(value, isLastMove, isWinningCell)"
                     style="grid-area: @(row + 1) / @(col + 1)"
                     @onclick="() => HandleCellClick(currentRow, currentCol)"
                     data-tooltip="@GetCellTooltip(currentRow, currentCol, value)">
                    @GetCellSymbol(value)
                </div>
            }
        }
    </div>
</div>

@code {
    [Parameter] public GameBoardState GameState { get; set; } = new();
    [Parameter] public EventCallback<(int Row, int Col)> OnCellClick { get; set; }
    [Parameter] public LastMoveInfo? LastMove { get; set; }

    public class LastMoveInfo
    {
        public int Row { get; set; }
        public int Col { get; set; }
        public PlayerType Player { get; set; }
    }

    private async Task HandleCellClick(int row, int col)
    {
        if (GameState.Board[row, col] == PlayerType.None && OnCellClick.HasDelegate)
        {
            await OnCellClick.InvokeAsync((row, col));
        }
    }

    private string GetCellClasses(PlayerType value, bool isLastMove, bool isWinningCell)
    {
        var classes = new List<string>();

        if (value != PlayerType.None)
            classes.Add("occupied");

        if (value == PlayerType.X)
            classes.Add("x-move");
        else if (value == PlayerType.O)
            classes.Add("o-move");

        if (isLastMove)
            classes.Add("last-move");

        if (isWinningCell)
            classes.Add("winning");

        return string.Join(" ", classes);
    }

    private string GetCellSymbol(PlayerType value)
    {
        return value switch
        {
            PlayerType.X => "X",
            PlayerType.O => "O",
            _ => ""
        };
    }

    private string GetCellTooltip(int row, int col, PlayerType value)
    {
        if (value != PlayerType.None)
        {
            return $"{GetCellSymbol(value)} at ({row + 1}, {col + 1})";
        }
        return $"Click to place at ({row + 1}, {col + 1})";
    }
}
