# Azure Developer CLI (azd) deployment workflow with OIDC authentication
# Deploys PoTicTac to Azure Container Apps using .NET Aspire

name: Azure Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write  # Required for OIDC authentication
  contents: read

env:
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install Azure Developer CLI
        uses: Azure/setup-azd@v2

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Build solution
        run: dotnet build PoTicTac.sln --configuration Release

      - name: Run unit tests
        run: dotnet test tests/Po.TicTac.UnitTests/Po.TicTac.UnitTests.csproj --configuration Release --no-build

      - name: Log in to azd (OIDC)
        run: |
          azd auth login `
            --client-id "${{ vars.AZURE_CLIENT_ID }}" `
            --federated-credential-provider "github" `
            --tenant-id "${{ vars.AZURE_TENANT_ID }}"
        shell: pwsh

      - name: Initialize azd environment
        run: |
          azd env new ${{ env.AZURE_ENV_NAME }} --no-prompt --location ${{ env.AZURE_LOCATION }} --subscription ${{ env.AZURE_SUBSCRIPTION_ID }} 2>$null || true
          azd env select ${{ env.AZURE_ENV_NAME }}
          azd env set AZURE_LOCATION ${{ env.AZURE_LOCATION }}
          azd env set AZURE_SUBSCRIPTION_ID ${{ env.AZURE_SUBSCRIPTION_ID }}
          azd env set AZURE_RESOURCE_GROUP "PoTicTac"
          azd env set STORAGE_TABLEENDPOINT "https://stpotictac.table.core.windows.net/"
          azd env set AZURE_KEY_VAULT_URI "https://kv-poshared.vault.azure.net/"
          azd env set MANAGED_IDENTITY_CLIENT_ID "c33cdcd2-6df9-4202-9c3a-2e3f5d5e1da5"
          azd env set AZURE_CONTAINER_REGISTRY_ENDPOINT "acrposhared.azurecr.io"
          azd env set AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID "/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}/resourceGroups/PoTicTac/providers/Microsoft.ManagedIdentity/userAssignedIdentities/id-potictac"
          azd env set AZURE_CONTAINER_APPS_ENVIRONMENT_ID "/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}/resourceGroups/PoShared/providers/Microsoft.App/managedEnvironments/cae-poshared"
        shell: pwsh

      - name: Deploy to Azure Container Apps
        run: azd deploy --no-prompt -e ${{ env.AZURE_ENV_NAME }}

      - name: Enable ingress
        run: |
          az containerapp ingress enable --name api --resource-group PoTicTac --type external --target-port 8080 --transport http 2>$null || true

      - name: Health check
        continue-on-error: true
        run: |
          $url = "https://api.braveground-e6b1356c.eastus.azurecontainerapps.io/health"
          Write-Host "Checking health at: $url"
          $maxRetries = 5
          for ($i = 1; $i -le $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 60
              if ($response.StatusCode -eq 200) {
                Write-Host "Health check passed!"
                exit 0
              }
            } catch {
              Write-Host "Attempt $i of $maxRetries failed. Waiting 30 seconds..."
              Start-Sleep -Seconds 30
            }
          }
          Write-Host "Health check failed after $maxRetries attempts (app may be scaled to zero)"
          exit 1
        shell: pwsh
