%%{ init: { 'theme': 'dark', 'themeVariables': { 'primaryColor': '#00d9ff', 'primaryTextColor': '#fff', 'lineColor': '#39ff14', 'secondaryColor': '#1a1a2e' } } }%%

%% PoTicTac Container Architecture Diagram (C4 Level 2)
%% Detailed view of application containers and their interactions

graph TB
    subgraph Browser["ğŸŒ Web Browser"]
        SPA["ğŸ“± React SPA<br/>(Po.TicTac.Web)<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ React 19 + TypeScript<br/>â€¢ Vite Build Tool<br/>â€¢ Client-side Game Logic<br/>â€¢ Local Storage Fallback"]
        
        subgraph ClientServices["Client Services"]
            GameLogic["ğŸ® GameLogicService<br/>Win Detection, Board State"]
            AILogic["ğŸ¤– AILogicService<br/>Easy/Medium/Hard AI"]
            LocalStorage["ğŸ’¾ LocalStorageService<br/>Offline Player Stats"]
            ApiClient["ğŸ“¡ StatisticsApi<br/>REST Client"]
        end
    end

    subgraph AzureContainerApps["â˜ï¸ Azure Container Apps (cae-poshared)"]
        subgraph APIContainer["ğŸ³ API Container"]
            AspNetApi["âš™ï¸ ASP.NET Core API<br/>(Po.TicTac.Api)<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ .NET 10 Minimal APIs<br/>â€¢ MediatR (CQRS)<br/>â€¢ HybridCache<br/>â€¢ Serilog Logging"]
            
            subgraph Features["Feature Modules"]
                HealthFeature["â¤ï¸ Health<br/>/api/health<br/>/alive"]
                StatisticsFeature["ğŸ“Š Statistics<br/>/api/statistics<br/>/api/statistics/leaderboard"]
                PlayersFeature["ğŸ‘¤ Players<br/>/api/players/{name}/stats"]
            end
            
            subgraph CoreServices["Core Services"]
                StorageService["ğŸ’¾ StorageService<br/>Azure Table CRUD"]
                OpenTelemetry["ğŸ“ˆ OpenTelemetry<br/>Distributed Tracing"]
                Serilog["ğŸ“ Serilog<br/>Structured Logging"]
            end
        end
    end

    subgraph AzureServices["â˜ï¸ Azure Services"]
        TableStorage["ğŸ’¾ Azure Table Storage<br/>(stpotictac)<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ PlayerStats Table<br/>â€¢ PartitionKey: 'Players'<br/>â€¢ RowKey: PlayerName"]
        
        KeyVault["ğŸ” Azure Key Vault<br/>(kv-poshared)<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Connection Strings<br/>â€¢ API Keys<br/>â€¢ App Insights Key"]
        
        AppInsights["ğŸ“ˆ Application Insights<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Request Tracing<br/>â€¢ Performance Metrics<br/>â€¢ Error Logging"]
        
        ACR["ğŸ“¦ Container Registry<br/>(acrposhared)<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ API Images<br/>â€¢ Web Images"]
    end

    subgraph Identity["ğŸ” Identity & Access"]
        ManagedIdentity["ğŸ†” Managed Identity<br/>(id-potictac)<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ DefaultAzureCredential<br/>â€¢ No Stored Secrets"]
    end

    %% SPA to Services
    SPA --> GameLogic
    SPA --> AILogic
    SPA --> LocalStorage
    SPA --> ApiClient

    %% API Calls
    ApiClient -->|"HTTP/REST<br/>JSON"| AspNetApi

    %% API Internal
    AspNetApi --> HealthFeature
    AspNetApi --> StatisticsFeature
    AspNetApi --> PlayersFeature
    HealthFeature --> StorageService
    StatisticsFeature --> StorageService
    PlayersFeature --> StorageService
    AspNetApi --> OpenTelemetry
    AspNetApi --> Serilog

    %% Azure Connections
    StorageService -->|"Table API<br/>Managed Identity"| TableStorage
    AspNetApi -->|"Configuration<br/>Managed Identity"| KeyVault
    OpenTelemetry -->|"Telemetry"| AppInsights
    Serilog -->|"Logs"| AppInsights
    
    %% Identity
    StorageService --> ManagedIdentity
    AspNetApi --> ManagedIdentity
    ManagedIdentity -->|"RBAC"| TableStorage
    ManagedIdentity -->|"RBAC"| KeyVault

    %% Container Registry
    ACR -.->|"Docker Images"| APIContainer

    %% Styling
    classDef browser fill:#2d2d44,stroke:#00d9ff,stroke-width:2px,color:#fff
    classDef container fill:#1a1a2e,stroke:#39ff14,stroke-width:2px,color:#fff
    classDef azure fill:#16213e,stroke:#ff6b6b,stroke-width:2px,color:#fff
    classDef identity fill:#0f3460,stroke:#ffd93d,stroke-width:2px,color:#fff

    class SPA,GameLogic,AILogic,LocalStorage,ApiClient browser
    class AspNetApi,HealthFeature,StatisticsFeature,PlayersFeature,StorageService,OpenTelemetry,Serilog container
    class TableStorage,KeyVault,AppInsights,ACR azure
    class ManagedIdentity identity
