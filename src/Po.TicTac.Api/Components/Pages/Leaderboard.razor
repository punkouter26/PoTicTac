@page "/leaderboard"
@rendermode InteractiveServer
@using Po.TicTac.Api.Services
@using Po.TicTac.Shared.DTOs
@using Po.TicTac.Shared.Models
@inject StorageService StorageService

<PageTitle>PoTicTac - Leaderboard</PageTitle>

<link href="css/stats.css" rel="stylesheet" />

<div class="stats-container">
    <h1 class="stats-title">üèÜ Leaderboard</h1>

    @if (isLoading)
    {
        <div class="stats-loading loading-container" role="status" aria-label="Loading leaderboard">
            <div class="skeleton skeleton-text title" aria-hidden="true"></div>
            <div class="skeleton skeleton-card large" aria-hidden="true"></div>
            <div class="skeleton skeleton-card large" aria-hidden="true"></div>
            <div class="skeleton skeleton-card large" aria-hidden="true"></div>
            <span class="sr-only">Loading leaderboard...</span>
        </div>
    }
    else if (playerStats == null || playerStats.Count == 0)
    {
        <div class="stats-content">
            <div class="no-data-message">
                <h3>No Leaderboard Data Available</h3>
                <p>Play some games to appear on the leaderboard!</p>
                <p>Statistics will be saved automatically after each game.</p>
            </div>
        </div>
    }
    else
    {
        <div class="stats-content">
            <LeaderboardSection Title="üü¢ Easy Leaderboard"
                                 Entries="easyLeaderboard"
                                 StatsSelector="GetEasyStats"
                                 EmptyMessage="No easy games played yet." />

            <LeaderboardSection Title="üü° Medium Leaderboard"
                                 Entries="mediumLeaderboard"
                                 StatsSelector="GetMediumStats"
                                 EmptyMessage="No medium games played yet." />

            <LeaderboardSection Title="üî¥ Hard Leaderboard"
                                 Entries="hardLeaderboard"
                                 StatsSelector="GetHardStats"
                                 EmptyMessage="No hard games played yet." />
        </div>
    }

    <div class="stats-nav-links">
        <a href="/" class="stats-back-button">üè† Back to Home</a>
        <a href="/playerstats" class="stats-back-button">üìä View Player Stats</a>
    </div>
</div>

@code {
    private List<PlayerStatsDto>? playerStats;
    private List<PlayerStatsDto> easyLeaderboard = [];
    private List<PlayerStatsDto> mediumLeaderboard = [];
    private List<PlayerStatsDto> hardLeaderboard = [];
    private bool isLoading = true;

    private static DifficultyStats GetEasyStats(PlayerStatsDto player) => player.Stats.Easy;
    private static DifficultyStats GetMediumStats(PlayerStatsDto player) => player.Stats.Medium;
    private static DifficultyStats GetHardStats(PlayerStatsDto player) => player.Stats.Hard;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatistics();
    }

    private static List<PlayerStatsDto> BuildLeaderboard(
        IEnumerable<PlayerStatsDto> source,
        Func<PlayerStatsDto, DifficultyStats> statsSelector)
    {
        return source
            .Select(player => new
            {
                Player = player,
                Stats = statsSelector(player)
            })
            .Where(entry => entry.Stats.TotalGames > 0)
            .OrderByDescending(entry => entry.Stats.WinRate)
            .ThenByDescending(entry => entry.Stats.TotalGames)
            .Take(10)
            .Select(entry => entry.Player)
            .ToList();
    }

    private async Task LoadStatistics()
    {
        isLoading = true;
        try
        {
            playerStats = await StorageService.GetAllPlayerStatsAsync();
            UpdateLeaderboards(playerStats);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading leaderboard: {ex.Message}");
            playerStats = [];
            UpdateLeaderboards(playerStats);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void UpdateLeaderboards(IEnumerable<PlayerStatsDto>? stats)
    {
        var players = stats?.ToList() ?? [];

        if (players.Count == 0)
        {
            easyLeaderboard = [];
            mediumLeaderboard = [];
            hardLeaderboard = [];
            return;
        }

        easyLeaderboard = BuildLeaderboard(players, GetEasyStats);
        mediumLeaderboard = BuildLeaderboard(players, GetMediumStats);
        hardLeaderboard = BuildLeaderboard(players, GetHardStats);
    }
}
