@page "/"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@namespace PoTicTac.Client.Pages
@using PoTicTac.Client.Models
@using Po.TicTac.Shared.Models
@using PoTicTac.Client.Services
@using ClientPlayerStats = PoTicTac.Client.Models.PlayerStats
@using SharedPlayerStats = Po.TicTac.Shared.Models.PlayerStats
@inject GameLogicService GameLogic
@inject AILogicService AILogic
@inject SignalRService SignalR
@inject StatisticsService StatisticsService
@inject IJSRuntime JSRuntime
@using PoTicTac.Client.Components
@inject NavigationManager NavigationManager
@implements IAsyncDisposable

<PageTitle>PoTicTac</PageTitle>

<link href="css/game.css" rel="stylesheet" />
<link href="css/gameboard.css" rel="stylesheet" />
<link href="css/difficulty-selector.css" rel="stylesheet" />

<div class="app">
    @{
        Console.WriteLine($"Current game mode: {gameMode}, gameState is null: {gameState == null}");
    }
    @if (gameMode == GameModeType.Menu)
    {
        <h1 class="game-title">POTICTAC</h1>

        <div class="menu">
            <div class="player-name-section">
                <label class="section-label">Your Name</label>
                <div class="player-name-input">
                    <input type="text" 
                           placeholder="Enter Your Name"
                           @bind="playerName"
                           @bind:event="oninput"
                           class="name-input @(string.IsNullOrWhiteSpace(playerName) ? "" : "has-value")" />
                    @if (!string.IsNullOrWhiteSpace(playerName))
                    {
                        <span class="input-check">✓</span>
                    }
                </div>
            </div>
            
            <div class="mode-selection">
                <label class="section-label">Game Mode</label>
                <div class="mode-buttons">
                    <button class="mode-button primary @(selectedMode == "single" ? "selected" : "")" 
                            @onclick="SelectSinglePlayer"
                            disabled="@isStartingGame">
                        <span class="mode-icon">🤖</span>
                        <span class="mode-text">Single Player</span>
                    </button>
                    <button class="mode-button secondary @(selectedMode == "multi" ? "selected" : "")" 
                            @onclick="SelectMultiplayer"
                            disabled="@isStartingGame">
                        <span class="mode-icon">👥</span>
                        <span class="mode-text">Multiplayer</span>
                        <span class="coming-soon-badge">Soon</span>
                    </button>
                </div>
            </div>
            
            @if (selectedMode == "single")
            {
                <div class="difficulty-section animate-in">
                    <DifficultySelector CurrentDifficulty="difficulty" 
                                      OnDifficultyChange="OnDifficultyChanged" />
                </div>
            }
            
            @if (canStartGame)
            {
                <div class="start-game-section">
                    <button class="start-game-button" 
                            @onclick="StartSelectedGame"
                            disabled="@isStartingGame">
                        @if (isStartingGame)
                        {
                            <span class="loading-spinner"></span>
                            <span>Starting...</span>
                        }
                        else
                        {
                            <span class="start-icon">▶</span>
                            <span>Start Game</span>
                        }
                    </button>
                </div>
            }
            
            <div class="stats-links">
                <a class="stats-link" @onclick="NavigateToPlayerStats" @onclick:preventDefault href="#">📊 My Stats</a>
                <span class="link-divider">|</span>
                <a class="stats-link" @onclick="NavigateToLeaderboard" @onclick:preventDefault href="#">🏆 Leaderboard</a>
            </div>
        </div>
        
    }
    else if (gameMode == GameModeType.Multiplayer)
    {
        <h1>Multiplayer Lobby</h1>
        <p>Multiplayer feature coming soon...</p>
        <button class="menu-button" @onclick="ReturnToMenu">
            Back to Menu
        </button>
    }
    else if (gameState != null)
    {
        Console.WriteLine($"Rendering game container. GameState is not null. Status: {gameState.GameStatus}, Current Player: {gameState.CurrentPlayer}");
        <div class="game-container">
            @if (gameState.GameStatus == GameStatus.Won)
            {
                <div class="game-status-overlay @GetStatusClass()">
                    @GetGameStatus()
                </div>
            }
            
            <div class="game-status">
                @GetGameStatus()
            </div>
            
            <GameBoard GameState="gameState" 
                       OnCellClick="HandleCellClick" 
                       LastMove="lastMove" />
        
            <div class="game-controls">
                <button @onclick="ReturnToMenu" class="menu-button">
                    Back to Menu
                </button>
                @if (gameMode == GameModeType.MultiplayerGame && gameState.GameStatus != GameStatus.Playing && multiplayerGame != null)
                {
                    <button @onclick="RequestRematch" class="rematch-button">
                        Request Rematch
                    </button>
                }
            </div>
        </div>
    }
</div>

@code {
    private enum GameModeType
    {
        Menu,
        Singleplayer,
        Multiplayer,
        MultiplayerGame
    }

    private GameModeType gameMode = GameModeType.Menu;
    private GameBoardState? gameState;
    private LastMoveInfo? lastMove;
    private Difficulty difficulty = Difficulty.Medium;
    private GameScore gameScore = new();
    private string playerName = string.Empty;
    private MultiplayerGameInfo? multiplayerGame;
    private ClientPlayerStats playerStats = new();
    private string selectedMode = string.Empty;
    private bool isStartingGame = false;
    private bool canStartGame => !string.IsNullOrWhiteSpace(selectedMode);

    protected override async Task OnInitializedAsync()
    {
        // Load player name from local storage if available
        try
        {
            var savedName = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "playerName");
            if (!string.IsNullOrEmpty(savedName))
            {
                playerName = savedName;
            }
        }
        catch
        {
            // Ignore localStorage errors
        }
    }

    private Task OnDifficultyChanged(Difficulty newDifficulty)
    {
        difficulty = newDifficulty;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void SelectSinglePlayer()
    {
        selectedMode = "single";
        StateHasChanged();
    }

    private void SelectMultiplayer()
    {
        selectedMode = "multi";
        StateHasChanged();
    }

    private async Task StartSelectedGame()
    {
        if (string.IsNullOrWhiteSpace(selectedMode)) return;
        
        isStartingGame = true;
        StateHasChanged();
        
        try
        {
            await Task.Delay(300); // Brief delay for visual feedback
            
            if (selectedMode == "single")
            {
                StartSinglePlayerGame();
            }
            else if (selectedMode == "multi")
            {
                await StartMultiplayerLobby();
            }
        }
        finally
        {
            isStartingGame = false;
        }
    }

    private async Task HandleCellClick((int Row, int Col) move)
    {
        if (gameState == null || gameState.GameStatus != GameStatus.Playing)
            return;

        // In multiplayer mode, only allow moves on your turn
        if (gameMode == GameModeType.MultiplayerGame)
        {
            if (multiplayerGame == null || gameState == null) return;
            
            try
            {
                await SignalR.MakeMoveAsync(multiplayerGame.GameId, move.Row, move.Col);
                // The game state will be updated via SignalR events
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error making move: {ex.Message}");
            }
            return;
        }

        // Single player mode
        if (gameState.CurrentPlayer != PlayerType.X)
            return;

        var newGameState = GameLogic.MakeMove(gameState, move.Row, move.Col);
        if (newGameState == gameState)
            return;

        gameState = newGameState;
        lastMove = new LastMoveInfo { Row = move.Row, Col = move.Col };
        StateHasChanged();

        // AI move in single player mode
        if (newGameState.GameStatus == GameStatus.Playing && newGameState.CurrentPlayer == PlayerType.O)
        {
            await Task.Delay(500); // Simulate thinking time
            var aiMove = await AILogic.GetAiMove(newGameState, difficulty);
            var afterAiMove = GameLogic.MakeMove(newGameState, aiMove[0], aiMove[1]);
            gameState = afterAiMove;
            lastMove = new LastMoveInfo { Row = aiMove[0], Col = aiMove[1] };
            StateHasChanged();
            
            // Save stats if game ended after AI move
            if (gameState.GameStatus != GameStatus.Playing)
            {
                Console.WriteLine($"🎮 Game ended after AI move. Status: {gameState.GameStatus}, Winner: {gameState.Winner}");
                await SaveSinglePlayerStats();
            }
        }
        // Save stats if player won or drew on their move
        else if (gameState.GameStatus != GameStatus.Playing)
        {
            Console.WriteLine($"🎮 Game ended after player move. Status: {gameState.GameStatus}, Winner: {gameState.Winner}");
            await SaveSinglePlayerStats();
        }
    }

    private string GetGameStatus()
    {
        if (gameState == null) return string.Empty;
        
        if (gameState.GameStatus == GameStatus.Won)
        {
            var winner = gameState.Players.FirstOrDefault(p => p.Symbol == gameState.Winner);
            if (gameMode == GameModeType.MultiplayerGame)
            {
                return $"{winner?.Name} Wins!";
            }
            return $"{(winner?.Type == PlayerType.Human ? "Player" : "AI")} Wins!";
        }
        
        if (gameState.GameStatus == GameStatus.Draw) 
            return "Draw!";
        
        if (gameMode == GameModeType.MultiplayerGame)
        {
            var currentPlayer = gameState.Players.FirstOrDefault(p => p.Symbol == gameState.CurrentPlayer);
            return $"{currentPlayer?.Name}'s Turn";
        }
        
        return $"{(gameState.CurrentPlayer == PlayerType.X ? "Player" : "AI")}'s Turn";
    }

    private void StartSinglePlayerGame()
    {
        Console.WriteLine("StartSinglePlayerGame called");
        var players = new Player[]
        {
            new Player 
            { 
                Id = "1", 
                Name = string.IsNullOrEmpty(playerName) ? "Player 1" : playerName, 
                Type = PlayerType.Human, 
                Symbol = PlayerType.X, 
                Stats = new ClientPlayerStats() 
            },
            new Player 
            { 
                Id = "2", 
                Name = "AI Player", 
                Type = PlayerType.AI, 
                Symbol = PlayerType.O, 
                AiConfig = new AIConfig { Difficulty = difficulty }, 
                Stats = new ClientPlayerStats() 
            }
        };
        
        gameState = GameLogic.CreateInitialState(PlayerType.X, players);
        Console.WriteLine($"Game state created: {gameState != null}, Board size: {gameState?.Board?.GetLength(0)}");
        Console.WriteLine($"Game mode set to: {GameModeType.Singleplayer}");
        gameMode = GameModeType.Singleplayer;
        lastMove = null;
        StateHasChanged();
        Console.WriteLine("StateHasChanged called");
    }

    private async Task StartMultiplayerLobby()
    {
        gameState = null;
        lastMove = null;
        gameMode = GameModeType.Multiplayer;
        
        try
        {
            await SignalR.ConnectAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error connecting to SignalR: {ex.Message}");
        }
        
        StateHasChanged();
    }

    private async Task ReturnToMenu()
    {
        if (gameMode == GameModeType.MultiplayerGame && multiplayerGame != null)
        {
            try
            {
                await SignalR.LeaveGameAsync(multiplayerGame.GameId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error leaving game: {ex.Message}");
            }
        }
        
        gameState = null;
        lastMove = null;
        multiplayerGame = null;
        gameMode = GameModeType.Menu;
        StateHasChanged();
    }

    private string GetStatusClass()
    {
        if (gameState?.GameStatus != GameStatus.Won) return string.Empty;
        
        if (gameMode == GameModeType.MultiplayerGame)
        {
            return "player-wins";
        }
        
        var winner = gameState.Players.FirstOrDefault(p => p.Symbol == gameState.Winner);
        if (winner?.Type == PlayerType.AI) return "ai-wins";
        if (winner?.Type == PlayerType.Human) return "player-wins";
        return string.Empty;
    }

    private async Task RequestRematch()
    {
        if (multiplayerGame != null)
        {
            try
            {
                await SignalR.RequestRematchAsync(multiplayerGame.GameId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error requesting rematch: {ex.Message}");
            }
        }
    }

    // Force full page load when navigating to server-rendered pages (different render mode)
    private void NavigateToPlayerStats() => NavigationManager.NavigateTo("/playerstats", forceLoad: true);
    private void NavigateToLeaderboard() => NavigationManager.NavigateTo("/leaderboard", forceLoad: true);

    private async Task SaveSinglePlayerStats()
    {
        Console.WriteLine($"SaveSinglePlayerStats called - playerName: {playerName}, gameState status: {gameState?.GameStatus}");
        
        if (gameState == null || string.IsNullOrEmpty(playerName))
        {
            Console.WriteLine("Skipping stats save - gameState is null or playerName is empty");
            return;
        }

        try
        {
            Console.WriteLine($"Attempting to save stats for {playerName} at difficulty {difficulty}");
            
            // Get existing stats or create new
            var existingStats = await StatisticsService.GetPlayerStats(playerName);
            Console.WriteLine($"Existing stats retrieved: {existingStats != null}");
            
            var stats = existingStats?.Stats ?? new SharedPlayerStats();
            Console.WriteLine($"Stats object created, difficulty: {difficulty}");

            // Determine which difficulty level to update
            DifficultyStats difficultyStats = difficulty switch
            {
                Difficulty.Easy => stats.Easy,
                Difficulty.Medium => stats.Medium,
                Difficulty.Hard => stats.Hard,
                _ => stats.Easy
            };

            // Update difficulty-specific stats
            difficultyStats.TotalGames++;
            
            var playerWon = gameState.GameStatus == GameStatus.Won && gameState.Winner == PlayerType.X;
            var aiWon = gameState.GameStatus == GameStatus.Won && gameState.Winner == PlayerType.O;
            var isDraw = gameState.GameStatus == GameStatus.Draw;

            if (playerWon)
            {
                difficultyStats.Wins++;
                difficultyStats.CurrentStreak++;
                if (difficultyStats.CurrentStreak > difficultyStats.WinStreak)
                {
                    difficultyStats.WinStreak = difficultyStats.CurrentStreak;
                }
            }
            else if (aiWon)
            {
                difficultyStats.Losses++;
                difficultyStats.CurrentStreak = 0;
            }
            else if (isDraw)
            {
                difficultyStats.Draws++;
                difficultyStats.CurrentStreak = 0;
            }

            // Update moves for this difficulty
            var playerMoves = gameState.MoveHistory.Count(m => m.Player == PlayerType.X);
            difficultyStats.TotalMoves += playerMoves;
            difficultyStats.AverageMovesPerGame = difficultyStats.TotalGames > 0
                ? (double)difficultyStats.TotalMoves / difficultyStats.TotalGames
                : 0;
            difficultyStats.WinRate = difficultyStats.TotalGames > 0
                ? (double)difficultyStats.Wins / difficultyStats.TotalGames
                : 0;

            // Update overall stats
            stats.TotalGames = stats.Easy.TotalGames + stats.Medium.TotalGames + stats.Hard.TotalGames;
            stats.TotalWins = stats.Easy.Wins + stats.Medium.Wins + stats.Hard.Wins;
            stats.TotalLosses = stats.Easy.Losses + stats.Medium.Losses + stats.Hard.Losses;
            stats.TotalDraws = stats.Easy.Draws + stats.Medium.Draws + stats.Hard.Draws;
            stats.OverallWinRate = stats.TotalGames > 0
                ? (double)stats.TotalWins / stats.TotalGames
                : 0;

            // Save to backend
            await StatisticsService.SavePlayerStats(playerName, stats);
            Console.WriteLine($"✅ Stats saved successfully for {playerName} - {difficulty} difficulty");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error saving stats: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Save player name to localStorage when it changes
            if (!string.IsNullOrEmpty(playerName))
            {
                try
                {
                    await JSRuntime.InvokeVoidAsync("localStorage.setItem", "playerName", playerName);
                }
                catch
                {
                    // Ignore localStorage errors
                }
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await SignalR.DisconnectAsync();
        }
        catch
        {
            // Ignore disposal errors
        }
    }
}
