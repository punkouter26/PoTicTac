@page "/stats"
@using PoTicTac.Client.Services
@using PoTicTac.Client.Models
@using Po.TicTac.Shared.DTOs
@using Po.TicTac.Shared.Models
@inject StatisticsService StatisticsService
@inject NavigationManager Navigation

<PageTitle>PoTicTac - Statistics</PageTitle>

<link href="css/stats.css" rel="stylesheet" />

<div class="stats-container">
    <h1 class="stats-title">Player Statistics</h1>

    @if (isLoading)
    {
        <div class="stats-loading loading-container" role="status" aria-label="Loading statistics">
            <div class="skeleton skeleton-text title" aria-hidden="true"></div>
            <div class="skeleton-stats-grid" aria-hidden="true">
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
            </div>
            <div class="skeleton skeleton-card large" aria-hidden="true"></div>
            <span class="sr-only">Loading player statistics...</span>
        </div>
    }
    else if (playerStats == null || !playerStats.Any())
    {
        <div class="stats-content">
            <div class="no-data-message">
                <h3>No Statistics Available</h3>
                <p>Play some games to see your statistics!</p>
                <p>Statistics will be saved automatically after each game.</p>
            </div>
            <div style="text-align: center;">
                <a href="/" class="stats-back-button">Back to Game</a>
            </div>
        </div>
    }
    else
    {
        <div class="stats-content">
            <StatsSummarySection Summary="summary" />

            <LeaderboardSection Title="ðŸŸ¢ Easy Leaderboard"
                                 Entries="easyLeaderboard"
                                 StatsSelector="GetEasyStats"
                                 EmptyMessage="No easy games played yet." />

            <LeaderboardSection Title="ðŸŸ¡ Medium Leaderboard"
                                 Entries="mediumLeaderboard"
                                 StatsSelector="GetMediumStats"
                                 EmptyMessage="No medium games played yet." />

            <LeaderboardSection Title="ðŸ”´ Hard Leaderboard"
                                 Entries="hardLeaderboard"
                                 StatsSelector="GetHardStats"
                                 EmptyMessage="No hard games played yet." />

            <!-- Back Button -->
            <div style="text-align: center;">
                <a href="/" class="stats-back-button">Back to Game</a>
            </div>
        </div>
    }
</div>

@code {
    private List<PlayerStatsDto>? playerStats;
    private List<PlayerStatsDto> easyLeaderboard = new();
    private List<PlayerStatsDto> mediumLeaderboard = new();
    private List<PlayerStatsDto> hardLeaderboard = new();
    private StatsSummaryModel summary = new();
    private bool isLoading = true;

    private static DifficultyStats GetEasyStats(PlayerStatsDto player) => player.Stats.Easy;
    private static DifficultyStats GetMediumStats(PlayerStatsDto player) => player.Stats.Medium;
    private static DifficultyStats GetHardStats(PlayerStatsDto player) => player.Stats.Hard;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatistics();
    }

    private static List<PlayerStatsDto> BuildLeaderboard(
        IEnumerable<PlayerStatsDto> source,
        Func<PlayerStatsDto, DifficultyStats> statsSelector)
    {
        return source
            .Select(player => new
            {
                Player = player,
                Stats = statsSelector(player)
            })
            .Where(entry => entry.Stats.TotalGames > 0)
            .OrderByDescending(entry => entry.Stats.WinRate)
            .ThenByDescending(entry => entry.Stats.TotalGames)
            .Take(10)
            .Select(entry => entry.Player)
            .ToList();
    }

    private async Task LoadStatistics()
    {
        isLoading = true;
        try
        {
            playerStats = await StatisticsService.GetAllPlayerStatistics();
            UpdateLeaderboards(playerStats);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading statistics: {ex.Message}");
            playerStats = new List<PlayerStatsDto>();
            UpdateLeaderboards(playerStats);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void UpdateLeaderboards(IEnumerable<PlayerStatsDto>? stats)
    {
        var players = stats?.ToList() ?? new List<PlayerStatsDto>();

        summary = StatsSummaryBuilder.FromPlayers(players);

        if (players.Count == 0)
        {
            easyLeaderboard = new List<PlayerStatsDto>();
            mediumLeaderboard = new List<PlayerStatsDto>();
            hardLeaderboard = new List<PlayerStatsDto>();
            return;
        }

        easyLeaderboard = BuildLeaderboard(players, GetEasyStats);
        mediumLeaderboard = BuildLeaderboard(players, GetMediumStats);
        hardLeaderboard = BuildLeaderboard(players, GetHardStats);
    }
}